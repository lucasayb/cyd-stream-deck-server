<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Stream Deck Custom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }
        .step:last-child::after {
            display: none;
        }
        .step.active .step-circle {
            background: #3b82f6;
            color: white;
        }
        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Configura√ß√£o Inicial</h1>
                <p class="text-gray-600">Configure seu Stream Deck Custom</p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator mb-8">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="text-sm text-gray-600">Usu√°rio</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="text-sm text-gray-600">Configura√ß√µes</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="text-sm text-gray-600">API Key</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="text-sm text-gray-600">Finalizar</div>
                </div>
            </div>

            <!-- Step 1: Usu√°rio -->
            <div id="stepContent1" class="step-content">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Criar Usu√°rio Administrador</h2>
                <p class="text-gray-600 mb-6">Crie uma conta de administrador para acessar o sistema.</p>
                
                <form id="userForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                        <input type="text" id="username" required minlength="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Digite seu usu√°rio">
                        <p class="text-xs text-gray-500 mt-1">M√≠nimo de 3 caracteres</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="password" required minlength="6"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Digite sua senha">
                        <p class="text-xs text-gray-500 mt-1">M√≠nimo de 6 caracteres</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                        <input type="password" id="confirmPassword" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Confirme sua senha">
                    </div>
                    
                    <div id="userError" class="text-red-500 text-sm hidden"></div>
                    
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Continuar
                    </button>
                </form>
            </div>

            <!-- Step 2: Configura√ß√µes -->
            <div id="stepContent2" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Configura√ß√µes do Sistema</h2>
                <p class="text-gray-600 mb-6">Configure as op√ß√µes do seu Stream Deck.</p>
                
                <form id="configForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            N√∫mero de Bot√µes (ESP32)
                        </label>
                        <input type="number" id="buttonCount" required min="1" max="20" value="6"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Quantos bot√µes ser√£o exibidos no display do ESP32 (1-20)</p>
                    </div>
                    
                    <div id="configError" class="text-red-500 text-sm hidden"></div>
                    
                    <div class="flex gap-2">
                        <button type="button" onclick="goToStep(1)"
                            class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                            Voltar
                        </button>
                        <button type="submit"
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                            Continuar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: API Key -->
            <div id="stepContent3" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">API Key Gerada</h2>
                <p class="text-gray-600 mb-6">Sua primeira API Key foi gerada automaticamente. Guarde-a com seguran√ßa!</p>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800 font-medium mb-2">‚ö†Ô∏è Importante</p>
                    <p class="text-sm text-yellow-700">Esta √© a √∫nica vez que voc√™ ver√° esta API Key. Certifique-se de copi√°-la antes de continuar.</p>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Sua API Key:</p>
                    <code id="apiKeyDisplay" class="text-sm text-gray-800 break-all block bg-white p-3 rounded border"></code>
                    <button onclick="copyApiKey()" 
                        class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                        üìã Copiar API Key
                    </button>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm font-medium text-blue-800 mb-2">Exemplo de uso (C/libcurl):</p>
                    <code id="exampleUrl" class="text-xs text-blue-700 break-all block"></code>
                </div>
                
                <div class="flex gap-2">
                    <button type="button" onclick="goToStep(2)"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                        Voltar
                    </button>
                    <button type="button" onclick="goToStep(4)"
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Continuar
                    </button>
                </div>
            </div>

            <!-- Step 4: Finaliza√ß√£o -->
            <div id="stepContent4" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Setup Conclu√≠do!</h2>
                <p class="text-gray-600 mb-6">Seu Stream Deck Custom est√° pronto para uso.</p>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium text-green-800">Tudo configurado com sucesso!</p>
                    </div>
                    <ul class="space-y-2 text-sm text-green-700">
                        <li>‚úÖ Usu√°rio administrador criado</li>
                        <li>‚úÖ Configura√ß√µes salvas</li>
                        <li>‚úÖ API Key gerada</li>
                        <li>‚úÖ Sistema pronto para uso</li>
                    </ul>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <p class="text-sm font-medium text-gray-700 mb-3">Como usar a API:</p>
                    <div class="space-y-2 text-xs text-gray-600">
                        <p><strong>Endpoint p√∫blico:</strong></p>
                        <code class="block bg-white p-2 rounded border">GET /api/execute/{position}?api_key=SUA_API_KEY</code>
                        <p class="mt-2"><strong>Exemplo completo:</strong></p>
                        <code class="block bg-white p-2 rounded border">curl "http://localhost:8000/api/execute/0?api_key=SUA_API_KEY"</code>
                    </div>
                </div>
                
                <button onclick="finishSetup()"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition font-medium">
                    Acessar Sistema
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let setupData = {
            username: '',
            password: '',
            button_count: 6,
            api_key: ''
        };
        
        // Inicializa o passo 1 ao carregar
        goToStep(1);

        // Step 1: Criar usu√°rio
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('userError');
            errorDiv.classList.add('hidden'); // Limpa erro anterior
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Valida√ß√µes b√°sicas
            if (username.length < 3) {
                errorDiv.textContent = 'Username deve ter pelo menos 3 caracteres';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Senha deve ter pelo menos 6 caracteres';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'As senhas n√£o coincidem';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            setupData.username = username;
            setupData.password = password;
            
            goToStep(2);
        });

        // Step 2: Configura√ß√µes
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('configError');
            errorDiv.classList.add('hidden'); // Limpa erro anterior
            
            const buttonCount = parseInt(document.getElementById('buttonCount').value);
            
            if (buttonCount < 1 || buttonCount > 20) {
                errorDiv.textContent = 'N√∫mero de bot√µes deve estar entre 1 e 20';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            setupData.button_count = buttonCount;
            
            // Completa o setup
            try {
                const response = await fetch('/api/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(setupData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setupData.api_key = data.api_key;
                    
                    // Atualiza display
                    document.getElementById('apiKeyDisplay').textContent = data.api_key;
                    const baseUrl = window.location.origin;
                    document.getElementById('exampleUrl').textContent = `${baseUrl}/api/execute/0?api_key=${data.api_key}`;
                    
                    goToStep(3);
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.detail || 'Erro ao completar setup';
                    
                    console.log('Erro no setup:', errorMessage, errorData);
                    
                    // Se o setup j√° foi completado, redireciona
                    if (errorMessage.includes('j√° foi completado') || errorMessage.includes('j√° completado') || errorMessage.includes('Setup j√° foi')) {
                        window.location.href = '/';
                        return;
                    }
                    
                    // Se o erro for especificamente sobre username j√° existir, volta para o passo 1
                    if (errorMessage.toLowerCase().includes('username j√° existe') || 
                        errorMessage.toLowerCase().includes('username ja existe') ||
                        (errorMessage.toLowerCase().includes('username') && errorMessage.toLowerCase().includes('j√° existe'))) {
                        document.getElementById('userError').textContent = errorMessage;
                        document.getElementById('userError').classList.remove('hidden');
                        goToStep(1, true); // Mant√©m o erro vis√≠vel
                        return;
                    }
                    
                    // Todos os outros erros ficam no passo 2
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao fazer requisi√ß√£o:', error);
                errorDiv.textContent = 'Erro de conex√£o: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        function goToStep(step, keepErrors = false) {
            // Limpa todos os erros ao mudar de passo (a menos que seja especificado para manter)
            if (!keepErrors) {
                document.getElementById('userError').classList.add('hidden');
                document.getElementById('configError').classList.add('hidden');
            }
            
            // Esconde todos os conte√∫dos e remove estados dos indicadores
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`stepContent${i}`).classList.add('hidden');
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
            }
            
            // Mostra conte√∫do do step atual
            document.getElementById(`stepContent${step}`).classList.remove('hidden');
            
            // Atualiza indicadores visuais
            // Marca passos anteriores como completed
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            // Marca passo atual como active
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
        }

        function copyApiKey() {
            const apiKey = document.getElementById('apiKeyDisplay').textContent;
            navigator.clipboard.writeText(apiKey).then(() => {
                alert('API Key copiada para a √°rea de transfer√™ncia!');
            });
        }

        function finishSetup() {
            window.location.href = '/';
        }

        // Verifica se setup j√° foi completado
        async function checkSetupStatus() {
            try {
                const response = await fetch('/api/setup/status');
                const data = await response.json();
                if (data.completed) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro ao verificar status do setup:', error);
            }
        }

        checkSetupStatus();
    </script>
</body>
</html>

